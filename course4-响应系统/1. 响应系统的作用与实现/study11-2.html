<!--
 * @Descripttion: å®ç°computed: ç¼ºé™·
 *                
 * @Author: xiangjun02
 * @Date: 2022-03-09 19:21:17
 * @LastEditors: xiangjun02
 * @LastEditTime: 2022-03-17 19:56:59
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å“åº”å¼ç³»ç»Ÿ-TODO</title>
  </head>
  <body>
    <div id="id1"></div>
    <div id="id2"></div>
    <script type="text/javascript">
      // å…³ç³»æ€»ç»“ï¼š
      // ä¸åŒeffectFn è¯»å– åŒä¸€ä¸ªtargetå’ŒåŒä¸€ä¸ªå±æ€§
      // ä¸åŒå±æ€§ è¢« åŒä¸€ä¸ªtargetå’ŒåŒä¸€ä¸ªeffectFnè¯»å–
      // ä¸åŒeffectFn è¯»å–ä¸åŒtarget å’Œ ä¸åŒçš„text

      // å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
      const bucket = new WeakMap();
      // å­˜å‚¨åŸå§‹æ•°æ®
      const data = {
        ok: true,
        text: "hello world",
        title: "å¤§å‘",
        desc: "desc >>> ",
        foo: 200,
        bar: 5,
      };

      // å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
      const obj = new Proxy(data, {
        // æ‹¦æˆªè¯»å–æ“ä½œ
        get(target, key) {
          // æ”¶é›†ä¾èµ–é›†åˆ
          trace(target, key);
          // è¿”å›å±æ€§å€¼
          return target[key];
        },
        set(target, key, newVal) {
          // è®¾ç½®å±æ€§å€¼
          target[key] = newVal;

          // è§¦å‘å‰¯ä½œç”¨å‡½æ•°å¹¶é‡æ–°æ‰§è¡Œ
          trigger(target, key);
        },
      });

      // effect æ ˆ
      const effectStack = [];
      // ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
      let activeEffect;
      // å‰¯ä½œç”¨å‡½æ•°ç”¨æˆ·æ³¨å†Œå‡½æ•°
      function effect(fn, options = {}) {
        const effectFn = () => {
          // è°ƒç”¨ä¹‹å‰ï¼Œæ‰§è¡Œæ¸…ç†å·¥ä½œ
          clearup(effectFn);
          // å½“effectFnæ‰§è¡Œæ—¶ï¼Œå°†å…¶è®¾ç½®ä¸ºå½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°
          activeEffect = effectFn;
          // æ–°å¢
          const res = fn();
          // åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ä¹‹å‰ï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹æ ˆ
          effectStack.push(effectFn);
          fn();
          // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°å®Œæ¯•åï¼ŒæŠŠå½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶è¿˜åŸactiveEffectä¸ºä¹‹å‰çš„å€¼
          effectStack.pop();
          activeEffect = effectStack[effectStack.length - 1];
          console.log("activeEffect >> ", activeEffect); // è¯»å–å…¶å€¼çš„å‰¯ä½œç”¨å‡½æ•°
          // å°†çœŸæ­£çš„fnæ‰§è¡Œç»“æœï¼Œä½œä¸ºeffectçš„è¿”å›å€¼
          return res;
        };
        // å°†optionsä¿å­˜èµ·æ¥
        effectFn.options = options;
        // ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆã€new Setã€‘
        effectFn.deps = [];

        if (!options.lazy) {
          // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
          effectFn();
        }
        return effectFn;
      }

      // æ¸…ç†å‡½æ•°
      function clearup(effectFn) {
        // æŠŠå½“å‰çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä»æ‰€æœ‰ä¾èµ–é›†åˆä¸­æ¸…æ¥š
        for (let i = 0; i < effectFn.deps.length; i++) {
          // ä¾èµ–é›†åˆçš„å¼•ç”¨
          const deps = effectFn.deps[i];
          // åˆ é™¤å‰¯ä½œç”¨å‡½æ•°,seté›†åˆ
          deps.delete(effectFn);
        }
        // æœ€åé‡ç½®æ•°ç»„é•¿åº¦
        effectFn.deps.length = 0;
      }

      // æ”¶é›†å‰¯ä½œç”¨å‡½æ•°çš„é€»è¾‘å°è£…trace
      function trace(target, key) {
        console.log("trace  >>> ", key);
        // æ²¡æœ‰activeEffectï¼Œç›´æ¥return
        if (!activeEffect) return;
        // æ ¹æ®target ä»æ¡¶ä¸­å–å¾—depsMapï¼ˆå¯¹è±¡ï¼‰, å®ƒä¹Ÿæ˜¯ä¸€ä¸ªmapç±»å‹ï¼škey --> effects
        let depsMap = bucket.get(target);

        // å¦‚æœä¸å­˜åœ¨depsMap,é‚£ä¹ˆæ–°å»ºä¸€ä¸ªMapå¹¶ä¸targetå…³è”
        if (!depsMap) {
          bucket.set(target, (depsMap = new Map()));

          // ç­‰ä»·äº
          // depsMap = new Map()
          // bucket.set(target, depsMap)
        }

        // å†æ ¹æ®keyä»depsMapä¸­è¯»å–depsï¼ˆå±æ€§å€¼ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªsetç±»å‹
        // é‡Œé¢å­˜å‚¨ç€æ‰€æœ‰ä¸å½“å‰keyç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ï¼šeffects
        let deps = depsMap.get(key);

        // å¦‚æœdepsä¸å­˜åœ¨ï¼ŒåŒæ ·æ–°å»ºä¸€ä¸ªSetå¹¶ä¸keyå…³è”
        if (!deps) {
          depsMap.set(key, (deps = new Set()));
        }

        // æœ€åå°†å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ·»åŠ åˆ°æ¡¶é‡Œ
        deps.add(activeEffect);

        // depså°±æ˜¯ä¸€ä¸ªä¸å½“å‰å‰¯ä½œç”¨å‡½æ•°å­˜åœ¨è”ç³»çš„ä¾èµ–é›†åˆ
        activeEffect.deps.push(deps); // æ–°å¢
      }

      // è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„é€»è¾‘å°è£…trigger
      function trigger(target, key) {
        console.log("trigger  >>>", key);
        // æ ¹æ®targetä»ğŸª£æ¡¶ä¸­å–å¾—depsMap,ä»–æ˜¯key ---> effects
        const depsMap = bucket.get(target);
        if (!depsMap) return;

        // è·å–keyä¾èµ–é›†åˆ
        const effects = depsMap.get(key);
        // æŠŠä¾èµ–é›†åˆåˆ¤æ–­å¹¶æ‰§è¡Œ
        // effects && effects.forEach((fn) => fn());

        const effectsToRun = new Set();
        effects.forEach((effectFn) => {
          // traceæ”¶é›†çš„å‰¯ä½œç”¨å‡½æ•°å’Œtrigeræ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ˜¯åŒä¸€ä¸ªã€‚
          if (activeEffect !== effectFn) {
            // å¢åŠ å®ˆå«æ¡ä»¶
            effectsToRun.add(effectFn);
          }
        });
        effectsToRun.forEach((effectFn) => {
          if (effectFn.options["scheduler"]) {
            effectFn.options["scheduler"](effectFn);
          } else {
            effectFn();
          }
        });
        return true;
      }

      // =================================
      function computed(getter) {
        // ç”¨æ¥ç¼“å­˜ä¸Šä¸€æ¬¡è®¡ç®—çš„å€¼
        let value;

        // ç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å€¼ï¼Œä¸ºtrueåˆ™æ„å‘³ç€â€œè„â€ï¼Œéœ€è¦è®¡ç®—
        let dirty = true;

        // æŠŠgetter ä½œä¸ºå‰¯ä½œç”¨å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªlazy çš„ effect
        const effectFn = effect(getter, {
          lazy: true,
          scheduler() {
            if (!dirty) {
              dirty = true;
              // å½“è®¡ç®—å±æ€§ä¾èµ–çš„å“åº”å¼å˜åŒ–æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨triggerå‡½æ•°è§¦å‘å“åº”
              trigger(obj, "value");
            }
          },
        });

        const obj = {
          //å½“è¯»å– valueå€¼çš„æ—¶æ‰æ‰§è¡ŒeffectFn
          get value() {
            if (dirty) {
              value = effectFn();
              dirty = false;
            }
            // å½“è¯»å–å€¼æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨traceè¿›è¡Œè¿½è¸ª
            trace(obj, "value");
            return value;
          },
        };
        return obj;
      }
      // å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œç»“æœ
      const sumRes = computed(() => obj.foo + obj.bar);
      console.log(sumRes.value);
      console.log(sumRes.value);
      obj.foo++;
      console.log(sumRes.value);

      // effect(() => {
      //   console.log(sumRes.value);
      // });
      // obj.foo++

      effect(()=>{
        // åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–sumReså€¼
        console.log(1111, sumRes.value)
      })
      // ä¿®æ”¹obj.fooçš„å€¼
      obj.foo++
    </script>
  </body>
</html>
