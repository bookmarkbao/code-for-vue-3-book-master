<!--
 * @Descripttion: é€»è¾‘1: å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°æ¡¶é‡Œçš„é€»è¾‘å°è£…ã€‚traceè¡¨ç¤ºè¿½è¸ªä¹‹æ„
 *                é€»è¾‘2:è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œçš„é€»è¾‘å°è£…ã€‚triggerè¡¨ç¤ºè§¦å‘ä¹‹æ„
 * @Author: xiangjun02
 * @Date: 2022-03-09 19:21:17
 * @LastEditors: xiangjun02
 * @LastEditTime: 2022-03-10 13:09:12
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å“åº”å¼ç³»ç»Ÿ-TODO</title>
  </head>
  <body>
    <div id="id1"></div>
    <div id="id2"></div>
    <script type="text/javascript">
      // å…³ç³»æ€»ç»“ï¼š
      // ä¸åŒeffectFn è¯»å– åŒä¸€ä¸ªtargetå’ŒåŒä¸€ä¸ªå±æ€§
      // ä¸åŒå±æ€§ è¢« åŒä¸€ä¸ªtargetå’ŒåŒä¸€ä¸ªeffectFnè¯»å–
      // ä¸åŒeffectFn è¯»å–ä¸åŒtarget å’Œ ä¸åŒçš„text

      // å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
      const bucket = new WeakMap();
      // å­˜å‚¨åŸå§‹æ•°æ®
      const data = {
        text: "hello world",
        title: "å¤§å‘"
      };

      // å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
      const obj = new Proxy(data, {
        // æ‹¦æˆªè¯»å–æ“ä½œ
        get(target, key) {
          // æ”¶é›†ä¾èµ–é›†åˆ
          trace(target, key);
          // è¿”å›å±æ€§å€¼
          return target[key];
        },
        set(target, key, newVal) {
          // è®¾ç½®å±æ€§å€¼
          target[key] = newVal;

          // è§¦å‘å‰¯ä½œç”¨å‡½æ•°å¹¶é‡æ–°æ‰§è¡Œ
          trigger(target, key)
        },
      });

      // ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
      let activeEffect;
      // å‰¯ä½œç”¨å‡½æ•°ç”¨æˆ·æ³¨å†Œå‡½æ•°
      function effect(fn) {
        activeEffect = fn;
        fn();
      }

      // æ”¶é›†å‰¯ä½œç”¨å‡½æ•°çš„é€»è¾‘å°è£…trace
      function trace(target, key) {
        console.log('trace  >>> ', key)
        // æ²¡æœ‰activeEffectï¼Œç›´æ¥return
        if (!activeEffect) return;

        // æ ¹æ®target ä»æ¡¶ä¸­å–å¾—depsMapï¼ˆå¯¹è±¡ï¼‰, å®ƒä¹Ÿæ˜¯ä¸€ä¸ªmapç±»å‹ï¼škey --> effects
        let depsMap = bucket.get(target);

        // å¦‚æœä¸å­˜åœ¨depsMap,é‚£ä¹ˆæ–°å»ºä¸€ä¸ªMapå¹¶ä¸targetå…³è”
        if (!depsMap) {
          bucket.set(target, (depsMap = new Map()));

          // ç­‰ä»·äº
          // depsMap = new Map()
          // bucket.set(target, depsMap)
        }

        // å†æ ¹æ®keyä»depsMapä¸­è¯»å–depsï¼ˆå±æ€§å€¼ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªsetç±»å‹
        // é‡Œé¢å­˜å‚¨ç€æ‰€æœ‰ä¸å½“å‰keyç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ï¼šeffects
        let deps = depsMap.get(key);

        // å¦‚æœdepsä¸å­˜åœ¨ï¼ŒåŒæ ·æ–°å»ºä¸€ä¸ªSetå¹¶ä¸keyå…³è”
        if (!deps) {
          depsMap.set(key, (deps = new Set()));
        }

        // æœ€åå°†å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ·»åŠ åˆ°æ¡¶é‡Œ
        deps.add(activeEffect);
      }

      // è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„é€»è¾‘å°è£…trigger
      function trigger(target, key){
          console.log('trigger  >>>', key)
          // æ ¹æ®targetä»ğŸª£æ¡¶ä¸­å–å¾—depsMap,ä»–æ˜¯key ---> effects
          const depsMap = bucket.get(target);
          if (!depsMap) return;

          // è·å–keyä¾èµ–é›†åˆ
          const effects = depsMap.get(key);
          // æŠŠä¾èµ–é›†åˆåˆ¤æ–­å¹¶æ‰§è¡Œ
          effects && effects.forEach((fn) => fn());
          return true;
      }

      effect(() => {
        console.log("effect fn1");
        // ä¸€ä¸ªåŒ¿åå‡½æ•°çš„å‰¯ä½œç”¨å‡½æ•°
        id1.innerText = obj.text;
        id1.innerText = obj.title;
        console.log(obj.text, obj.title)
      });

      effect(() => {
        console.log("effect fn2");
        // ä¸€ä¸ªåŒ¿åå‡½æ•°çš„å‰¯ä½œç”¨å‡½æ•°
        id2.innerText = obj.text;
      });
     
    </script>
  </body>
</html>
