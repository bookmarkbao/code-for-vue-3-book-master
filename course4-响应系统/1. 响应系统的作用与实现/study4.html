<!--
 * @Descripttion: å“åº”å¼ç³»ç»Ÿä¹‹æ¡¶æ”¹é€ WeakMap
 * @Author: xiangjun02
 * @Date: 2022-03-09 19:21:17
 * @LastEditors: xiangjun02
 * @LastEditTime: 2022-03-09 20:33:23
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å“åº”å¼ç³»ç»Ÿ-TODO</title>
  </head>
  <body>
    <div id="id1"></div>
    <div id="id2"></div>
    <script type="text/javascript">
      // WeakMapè¯´æ˜ï¼š
      // 1ã€å­˜å‚¨åŸå§‹æ•°æ®ç»“æ„çš„ä½¼ä½¼è€…
      // 2ã€keyå¿…é¡»æ˜¯å¯¹è±¡ï¼ˆObjectæˆ– Symbol)
      // 3ã€4æ–¹æ³•ï¼šdelete, get, has, set
      // 4ã€ä¸€ä¸ªå±æ€§ï¼šconstructorç”¨äºåˆ›å»ºå®ä¾‹
      // æ³¨æ„ï¼šWeakMapä¸èƒ½åŒ…å«æ— å¼•ç”¨çš„å¯¹è±¡ï¼Œå¦åˆ™ä¼šè¢«è‡ªåŠ¨æ¸…é™¤å‡ºé›†åˆï¼ˆåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰
      // åœºæ™¯1ï¼š
      // ï¼ˆ1ï¼‰æƒ³è¦ç»™ç½‘é¡µçš„domå…ƒç´ ä¸Šæ·»åŠ æ•°æ®æ—¶å¯ç”¨ WeakMapï¼š
      // ç”¨ WeakMap å¥½å¤„æ˜¯å½“è¯¥ DOM å…ƒç´ è¢«æ¸…é™¤ï¼Œå¯¹åº”çš„ WeakMapè®°å½•å°±ä¼šè‡ªåŠ¨è¢«ç§»é™¤
      // åœºæ™¯2:
      // ï¼ˆ2ï¼‰è¿›ä¸€æ­¥è¯´ï¼Œæ³¨å†Œç›‘å¬äº‹ä»¶çš„listenerå¯¹è±¡å¾ˆé€‚åˆç”¨WeakMapæ¥å®ç°
      // https://www.cnblogs.com/zwjun/p/14421405.html

      // å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
      const bucket = new WeakMap();
      // å­˜å‚¨åŸå§‹æ•°æ®
      const data = {
        text: "hello world",
      };

      // å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
      const obj = new Proxy(data, {
        // æ‹¦æˆªè¯»å–æ“ä½œ
        get(target, key) {
          // æ²¡æœ‰activeEffectï¼Œç›´æ¥return
          if (!activeEffect) return;

          // æ ¹æ®target ä»æ¡¶ä¸­å–å¾—depsMapï¼ˆå¯¹è±¡ï¼‰, å®ƒä¹Ÿæ˜¯ä¸€ä¸ªmapç±»å‹ï¼škey --> effects
          let depsMap = bucket.get(target);

          // å¦‚æœä¸å­˜åœ¨depsMap,é‚£ä¹ˆæ–°å»ºä¸€ä¸ªMapå¹¶ä¸targetå…³è”
          if (!depsMap) {
            bucket.set(target, (depsMap = new Map()));

            // ç­‰ä»·äº
            // depsMap = new Map()
            // bucket.set(target, depsMap)
          }

          // å†æ ¹æ®keyä»depsMapä¸­è¯»å–depsï¼ˆå±æ€§å€¼ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªsetç±»å‹
          // é‡Œé¢å­˜å‚¨ç€æ‰€æœ‰ä¸å½“å‰keyç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ï¼šeffects
          let deps = depsMap.get(key);

          // å¦‚æœdepsä¸å­˜åœ¨ï¼ŒåŒæ ·æ–°å»ºä¸€ä¸ªSetå¹¶ä¸keyå…³è”
          if (!deps) {
            depsMap.set(key, (deps = new Set()));
          }

          // æœ€åå°†å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ·»åŠ åˆ°æ¡¶é‡Œ
          deps.add(activeEffect);

          // è¿”å›å±æ€§å€¼
          return target[key];
        },
        set(target, key, newVal) {
          // è®¾ç½®å±æ€§å€¼
          target[key] = newVal;

          // æ ¹æ®targetä»ğŸª£æ¡¶ä¸­å–å¾—depsMap,ä»–æ˜¯key ---> effects
          const depsMap = bucket.get(target);

          if (!depsMap) return;

          // è·å–keyä¾èµ–é›†åˆ
          const effects = depsMap.get(key);
          // æŠŠä¾èµ–é›†åˆåˆ¤æ–­å¹¶æ‰§è¡Œ
          effects && effects.forEach((fn) => fn());
          return true;
        },
      });

      // ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
      let activeEffect;
      // å‰¯ä½œç”¨å‡½æ•°ç”¨æˆ·æ³¨å†Œå‡½æ•°
      function effect(fn) {
        activeEffect = fn;
        fn();
      }

      effect(() => {
        console.log("effect fn");
        // ä¸€ä¸ªåŒ¿åå‡½æ•°çš„å‰¯ä½œç”¨å‡½æ•°
        id1.innerText = obj.text;
      });

      effect(() => {
        console.log("effect fn");
        // ä¸€ä¸ªåŒ¿åå‡½æ•°çš„å‰¯ä½œç”¨å‡½æ•°
        id2.innerText = obj.text;
      });
    </script>
  </body>
</html>
