<!--
 * @Descripttion: ÈÄªËæë1: ÂâØ‰ΩúÁî®ÂáΩÊï∞Êî∂ÈõÜÂà∞Ê°∂ÈáåÁöÑÈÄªËæëÂ∞ÅË£Ö„ÄÇtraceË°®Á§∫ËøΩË∏™‰πãÊÑè
 *                ÈÄªËæë2:Ëß¶ÂèëÂâØ‰ΩúÁî®ÂáΩÊï∞ÈáçÊñ∞ÊâßË°åÁöÑÈÄªËæëÂ∞ÅË£Ö„ÄÇtriggerË°®Á§∫Ëß¶Âèë‰πãÊÑè
 * @Author: xiangjun02
 * @Date: 2022-03-09 19:21:17
 * @LastEditors: xiangjun02
 * @LastEditTime: 2022-03-09 21:02:50
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÂìçÂ∫îÂºèÁ≥ªÁªü-TODO</title>
  </head>
  <body>
    <div id="id1"></div>
    <div id="id2"></div>
    <script type="text/javascript">
      // ÂÖ≥Á≥ªÊÄªÁªìÔºö
      // ‰∏çÂêåeffectFn ËØªÂèñ Âêå‰∏Ä‰∏™targetÂíåÂêå‰∏Ä‰∏™Â±ûÊÄß
      // ‰∏çÂêåÂ±ûÊÄß Ë¢´ Âêå‰∏Ä‰∏™targetÂíåÂêå‰∏Ä‰∏™effectFnËØªÂèñ
      // ‰∏çÂêåeffectFn ËØªÂèñ‰∏çÂêåtarget Âíå ‰∏çÂêåÁöÑtext

      // Â≠òÂÇ®ÂâØ‰ΩúÁî®ÂáΩÊï∞ÁöÑÊ°∂
      const bucket = new WeakMap();
      // Â≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ
      const data = {
        text: "hello world",
      };

      // ÂØπÂéüÂßãÊï∞ÊçÆÁöÑ‰ª£ÁêÜ
      const obj = new Proxy(data, {
        // Êã¶Êà™ËØªÂèñÊìç‰Ωú
        get(target, key) {
          // Êî∂ÈõÜ‰æùËµñÈõÜÂêà
          trace(target, key);
          // ËøîÂõûÂ±ûÊÄßÂÄº
          return target[key];
        },
        set(target, key, newVal) {
          // ËÆæÁΩÆÂ±ûÊÄßÂÄº
          target[key] = newVal;
          // Ëß¶ÂèëÂâØ‰ΩúÁî®ÂáΩÊï∞Âπ∂ÈáçÊñ∞ÊâßË°å
          trigger(target, key)
        },
      });

      // Áî®‰∏Ä‰∏™ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®Ë¢´Ê≥®ÂÜåÁöÑÂâØ‰ΩúÁî®ÂáΩÊï∞
      let activeEffect;
      // ÂâØ‰ΩúÁî®ÂáΩÊï∞Áî®Êà∑Ê≥®ÂÜåÂáΩÊï∞
      function effect(fn) {
        activeEffect = fn;
        fn();
      }

      // Êî∂ÈõÜÂâØ‰ΩúÁî®ÂáΩÊï∞ÁöÑÈÄªËæëÂ∞ÅË£Ötrace
      function trace(target, key) {
        // Ê≤°ÊúâactiveEffectÔºåÁõ¥Êé•return
        if (!activeEffect) return;

        // Ê†πÊçÆtarget ‰ªéÊ°∂‰∏≠ÂèñÂæódepsMapÔºàÂØπË±°Ôºâ, ÂÆÉ‰πüÊòØ‰∏Ä‰∏™mapÁ±ªÂûãÔºökey --> effects
        let depsMap = bucket.get(target);

        // Â¶ÇÊûú‰∏çÂ≠òÂú®depsMap,ÈÇ£‰πàÊñ∞Âª∫‰∏Ä‰∏™MapÂπ∂‰∏étargetÂÖ≥ËÅî
        if (!depsMap) {
          bucket.set(target, (depsMap = new Map()));

          // Á≠â‰ª∑‰∫é
          // depsMap = new Map()
          // bucket.set(target, depsMap)
        }

        // ÂÜçÊ†πÊçÆkey‰ªédepsMap‰∏≠ËØªÂèñdepsÔºàÂ±ûÊÄßÂÄºÔºâÔºåÂÆÉÊòØ‰∏Ä‰∏™setÁ±ªÂûã
        // ÈáåÈù¢Â≠òÂÇ®ÁùÄÊâÄÊúâ‰∏éÂΩìÂâçkeyÁõ∏ÂÖ≥ËÅîÁöÑÂâØ‰ΩúÁî®ÂáΩÊï∞Ôºöeffects
        let deps = depsMap.get(key);

        // Â¶ÇÊûúdeps‰∏çÂ≠òÂú®ÔºåÂêåÊ†∑Êñ∞Âª∫‰∏Ä‰∏™SetÂπ∂‰∏ékeyÂÖ≥ËÅî
        if (!deps) {
          depsMap.set(key, (deps = new Set()));
        }

        // ÊúÄÂêéÂ∞ÜÂΩìÂâçÊøÄÊ¥ªÁöÑÂâØ‰ΩúÁî®ÂáΩÊï∞ÔºåÊ∑ªÂä†Âà∞Ê°∂Èáå
        deps.add(activeEffect);
      }

      // Ëß¶ÂèëÂâØ‰ΩúÁî®ÂáΩÊï∞ÁöÑÈÄªËæëÂ∞ÅË£Ötrigger
      function trigger(target, key){

          // Ê†πÊçÆtarget‰ªéü™£Ê°∂‰∏≠ÂèñÂæódepsMap,‰ªñÊòØkey ---> effects
          const depsMap = bucket.get(target);
          if (!depsMap) return;

          // Ëé∑Âèñkey‰æùËµñÈõÜÂêà
          const effects = depsMap.get(key);
          // Êää‰æùËµñÈõÜÂêàÂà§Êñ≠Âπ∂ÊâßË°å
          effects && effects.forEach((fn) => fn());
          return true;
      }

      effect(() => {
        console.log("effect fn");
        // ‰∏Ä‰∏™ÂåøÂêçÂáΩÊï∞ÁöÑÂâØ‰ΩúÁî®ÂáΩÊï∞
        id1.innerText = obj.text;
      });

      setTimeout(() =>{
        obj.text = 'hello xiangjun'
      }, 2000)
    </script>
  </body>
</html>
